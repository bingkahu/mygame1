<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIRBY: OHIO SLOP EDITION</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Permanent Marker', cursive; }
        canvas { display: block; filter: contrast(1.2) saturate(1.5); }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }
        .stats { padding: 20px; color: #fff; text-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff; font-size: 24px; }
        .combo-meter { font-size: 50px; color: #00ffff; transform: rotate(-5deg); animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }
        
        #fever-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(45deg, rgba(255,0,0,0.1), rgba(255,0,0,0.1) 10px, rgba(0,0,255,0.1) 10px, rgba(0,0,255,0.1) 20px);
            display: none; z-index: 5; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="fever-overlay"></div>
<div id="ui-layer">
    <div class="stats">
        <div>SCORE: <span id="score">0</span></div>
        <div id="combo-box" style="visibility:hidden">COMBO x<span id="combo">1</span></div>
    </div>
    <div class="stats" style="text-align: right; color: #00ff00;">
        [SHIFT] INHALE THE SLOP<br>[SPACE] FLY TO OHIO<br>[X] SPIT FIRE
    </div>
</div>
<canvas id="game"></canvas>

<script>
/**
 * BRAINROT ENGINE v5.0 - MAXIMALIST OVERHAUL
 */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const comboEl = document.getElementById('combo');
const comboBx = document.getElementById('combo-box');
const fever = document.getElementById('fever-overlay');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- CRITICAL AUDIO ---
const audio = new (window.AudioContext || window.webkitAudioContext)();
function playExplosion(freq) {
    if(audio.state === 'suspended') audio.resume();
    const o = audio.createOscillator(), g = audio.createGain();
    o.type = 'sawtooth'; o.frequency.setValueAtTime(freq, audio.currentTime);
    o.frequency.exponentialRampToValueAtTime(10, audio.currentTime + 0.5);
    g.gain.setValueAtTime(0.3, audio.currentTime);
    g.gain.linearRampToValueAtTime(0, audio.currentTime + 0.5);
    o.connect(g); g.connect(audio.destination);
    o.start(); o.stop(audio.currentTime + 0.5);
}

// --- GAME STATE ---
let state = {
    score: 0, combo: 0, comboTimer: 0,
    feverMode: false, shake: 0, time: 0,
    cameraX: 0,
    particles: [], enemies: [], platforms: [], bullets: []
};

const keys = {};
window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y;
        this.vx = (Math.random() - 0.5) * 20;
        this.vy = (Math.random() - 0.5) * 20;
        this.color = color; this.life = 1.0;
    }
    draw() {
        this.x += this.vx; this.y += this.vy; this.life -= 0.03;
        ctx.fillStyle = this.color;
        ctx.globalAlpha = this.life;
        ctx.fillRect(this.x - state.cameraX, this.y, 8, 8);
        ctx.globalAlpha = 1;
    }
}

const player = {
    x: 200, y: 300, vx: 0, vy: 0, w: 50, h: 50,
    facing: 1, inhaling: false,
    update() {
        if(keys.ArrowRight) { this.vx += 1.5; this.facing = 1; }
        if(keys.ArrowLeft) { this.vx -= 1.5; this.facing = -1; }
        if(keys.Space) this.vy = -7;
        
        this.inhaling = keys.ShiftLeft || keys.ShiftRight;
        this.vx *= 0.85; this.vy += 0.6;
        this.x += this.vx; this.y += this.vy;

        // Ground check
        if(this.y > canvas.height - 100) { this.y = canvas.height - 100; this.vy = 0; }
        
        if(this.inhaling) this.doInhale();
        if(keys.KeyX && state.time % 10 === 0) this.spit();
    },
    doInhale() {
        state.enemies.forEach(e => {
            let dx = this.x - e.x;
            if(Math.abs(dx) < 300 && Math.sign(-dx) === this.facing) {
                e.x += dx * 0.1; e.y += (this.y - e.y) * 0.1;
                if(Math.abs(dx) < 40) { e.dead = true; this.triggerCombo(); }
            }
        });
    },
    triggerCombo() {
        state.combo++; state.comboTimer = 100;
        state.score += 100 * state.combo;
        state.shake = 15;
        playExplosion(200 + state.combo * 50);
        for(let i=0; i<10; i++) state.particles.push(new Particle(this.x + 50*this.facing, this.y, '#ff00ff'));
    },
    spit() {
        state.bullets.push({x: this.x, y: this.y, vx: this.facing * 20});
        state.shake = 5;
    },
    draw() {
        ctx.save();
        ctx.translate(this.x - state.cameraX + 25, this.y + 25);
        if(this.inhaling) ctx.scale(1.5, 0.8);
        
        // Rainbow Kirby
        ctx.fillStyle = `hsl(${state.time % 360}, 100%, 70%)`;
        ctx.beginPath(); ctx.arc(0,0, 25, 0, Math.PI*2); ctx.fill();
        
        // Hyper Eyes
        ctx.fillStyle = '#000';
        ctx.fillRect(5 * this.facing, -10, 6, 15);
        ctx.fillStyle = '#fff';
        ctx.fillRect(5 * this.facing, -10, 2, 2);
        ctx.restore();
    }
};

// --- SPAWN LOGIC ---
function spawnWorld() {
    for(let i=0; i<100; i++) {
        state.platforms.push({x: i*400, y: canvas.height - 150 - Math.random()*300, w: 200, h: 40});
        state.enemies.push({x: i*400 + 100, y: 100, dead: false, color: `hsl(${Math.random()*360}, 100%, 50%)`});
    }
}

function loop() {
    state.time++;
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0, canvas.width, canvas.height);

    // Camera
    state.cameraX += (player.x - canvas.width/4 - state.cameraX) * 0.1;

    // Shake
    if(state.shake > 0) {
        ctx.translate(Math.random()*state.shake, Math.random()*state.shake);
        state.shake *= 0.9;
    }

    // Background Glitch
    if(state.combo > 5) {
        ctx.fillStyle = 'rgba(0,255,255,0.1)';
        ctx.fillRect(Math.random()*canvas.width, 0, 50, canvas.height);
        fever.style.display = 'block';
    } else {
        fever.style.display = 'none';
    }

    // Platforms
    ctx.fillStyle = '#333';
    state.platforms.forEach(p => {
        ctx.shadowBlur = 15; ctx.shadowColor = '#0ff';
        ctx.fillRect(p.x - state.cameraX, p.y, p.w, p.h);
        if(player.x+player.w > p.x && player.x < p.x+p.w && player.y+player.h > p.y && player.y+player.h < p.y+p.h+20 && player.vy > 0) {
            player.y = p.y - player.h; player.vy = 0;
        }
    });
    ctx.shadowBlur = 0;

    // Enemies
    state.enemies.forEach(e => {
        if(!e.dead) {
            e.y += 2; if(e.y > canvas.height) e.y = 0;
            ctx.fillStyle = e.color;
            ctx.fillRect(e.x - state.cameraX, e.y, 40, 40);
            // Hit by bullet
            state.bullets.forEach(b => {
                if(Math.abs(b.x - e.x) < 40 && Math.abs(b.y - e.y) < 40) {
                    e.dead = true; player.triggerCombo();
                }
            });
        }
    });

    // Bullets & Particles
    state.bullets.forEach((b,i) => { b.x += b.vx; ctx.fillStyle='white'; ctx.fillRect(b.x-state.cameraX, b.y, 20, 20); if(Math.abs(b.x-player.x)>1000) state.bullets.splice(i,1);});
    state.particles.forEach((p,i) => { p.draw(); if(p.life<=0) state.particles.splice(i,1); });

    player.update();
    player.draw();

    // UI
    scoreEl.innerText = state.score;
    if(state.comboTimer > 0) {
        state.comboTimer--;
        comboBx.style.visibility = 'visible';
        comboEl.innerText = state.combo;
    } else {
        state.combo = 0;
        comboBx.style.visibility = 'hidden';
    }

    requestAnimationFrame(loop);
}

spawnWorld();
loop();
</script>
</body>
</html>
