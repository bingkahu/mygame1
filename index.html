```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quantum Bakery — Insane Clicker Forge (Admin Mode)</title>

  <!--
    Quantum Bakery — Insane Clicker Forge
    Author: Copilot (Lead Game Developer role)
    Single-file HTML5/JS/CSS. No external libraries. Everything raw.

    Design goals:
      - Cookie-clicker style core loop with absurd depth, polish, and "juice".
      - Admin Mode gated by password: Admin123123 (case-sensitive).
      - Massive internal CSS (300+ lines) with gradients, glassmorphism, keyframes for UI.
      - Multi-stage engine: Loading, Main Menu, Bakery, Factory, Research, Prestige, Achievements, Settings, Admin Console.
      - Heavy Particle System for clicks, upgrades, prestige bursts, and admin fireworks.
      - Procedural Web Audio API: clicks, purchase, upgrade, prestige fanfare, admin unlock, error buzz.
      - Complex production logic: buildings, synergies, buffs, timed events, golden biscuits, random storms.
      - Save system: localStorage with versioning, migration, and integrity checks.
      - Debug overlays: performance stats, hitboxes, particle trails, audio scopes.
      - Verbose documentation: every function and variable commented.

    If we hit a character limit, I will stop exactly where I am—say “Continue” to resume.
  -->

  <style>
    /* =========================================================================
       Massive Internal CSS — 300+ lines with gradients, glassmorphism, keyframes
       ========================================================================= */

    /* -- Reset --------------------------------------------------------------- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%; height: 100%;
      background:
        radial-gradient(1200px at 50% 50%, #0b0f1e 0%, #090d18 60%, #070a14 100%),
        linear-gradient(180deg, rgba(10,14,24,0.8), rgba(6,8,15,0.8));
      color: #eef6ff;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      overflow: hidden;
    }

    /* -- Root Variables ------------------------------------------------------ */
    :root {
      --glass-bg: rgba(255,255,255,0.08);
      --glass-border: rgba(255,255,255,0.22);
      --text: #eef6ff;
      --muted: #9fb3c8;
      --accent: #6cf0ff;
      --accent-2: #ff6cf0;
      --accent-3: #f0ff6c;
      --danger: #ff4d6d;
      --ok: #4dff88;
      --shadow: rgba(0,0,0,0.35);
      --panel-radius: 18px;
      --btn-radius: 14px;
      --hud-radius: 12px;
      --blur: blur(12px);
      --glow: 0 0 12px rgba(108,240,255,0.6), 0 0 24px rgba(108,240,255,0.3);
      --glow-strong: 0 0 24px rgba(108,240,255,0.8), 0 0 48px rgba(108,240,255,0.4);
      --panel-gradient: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      --panel-radial: radial-gradient(800px at 50% 0%, rgba(108,240,255,0.18), transparent 60%);
      --danger-radial: radial-gradient(800px at 50% 0%, rgba(255,77,109,0.18), transparent 60%);
      --ok-radial: radial-gradient(800px at 50% 0%, rgba(77,255,136,0.18), transparent 60%);
      --ring-color: rgba(108,240,255,0.35);
      --gold: #ffd166;
      --choco: #8d5a3a;
      --cream: #fff3d6;
    }

    /* -- Background Layers --------------------------------------------------- */
    .bg-layer {
      position: fixed; inset: 0; pointer-events: none; z-index: -1;
      background:
        radial-gradient(800px at 20% 20%, rgba(108,240,255,0.08), transparent 60%),
        radial-gradient(800px at 80% 30%, rgba(255,108,240,0.08), transparent 60%),
        radial-gradient(800px at 40% 80%, rgba(240,255,108,0.08), transparent 60%);
      animation: bgPulse 12s ease-in-out infinite;
    }
    @keyframes bgPulse {
      0% { filter: saturate(1) brightness(1); }
      50% { filter: saturate(1.2) brightness(1.08); }
      100% { filter: saturate(1) brightness(1); }
    }

    /* -- Container ----------------------------------------------------------- */
    .container {
      position: relative; width: 100%; height: 100%;
      display: grid; grid-template-rows: auto 1fr auto; grid-template-columns: 1fr;
      align-items: center; justify-items: center;
    }

    /* -- Panels -------------------------------------------------------------- */
    .panel {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: var(--panel-radius);
      box-shadow: 0 10px 30px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.05);
      backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
      padding: 24px; color: var(--text);
    }
    .panel-title {
      font-size: 28px; font-weight: 800; letter-spacing: 0.5px; text-shadow: var(--glow);
      background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      animation: titleGlow 3s ease-in-out infinite;
    }
    @keyframes titleGlow {
      0% { text-shadow: 0 0 8px rgba(108,240,255,0.4); }
      50% { text-shadow: var(--glow-strong); }
      100% { text-shadow: 0 0 8px rgba(108,240,255,0.4); }
    }

    /* -- Buttons ------------------------------------------------------------- */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 10px;
      padding: 12px 18px; border-radius: var(--btn-radius); border: 1px solid var(--glass-border);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)),
        radial-gradient(400px at 50% 0%, rgba(108,240,255,0.25), transparent 60%);
      color: var(--text); font-weight: 700; letter-spacing: 0.4px; cursor: pointer;
      box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
      animation: btnPulse 4s ease-in-out infinite;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 24px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.08); filter: saturate(1.2); }
    .btn:active { transform: translateY(1px) scale(0.99); animation: btnClick 0.3s ease; }
    @keyframes btnPulse { 0%{filter:brightness(1);} 50%{filter:brightness(1.08);} 100%{filter:brightness(1);} }
    @keyframes btnClick { 0%{transform:scale(1);} 50%{transform:scale(0.98);} 100%{transform:scale(1);} }
    .btn-primary {
      background:
        linear-gradient(180deg, rgba(108,240,255,0.25), rgba(108,240,255,0.12)),
        radial-gradient(400px at 50% 0%, rgba(108,240,255,0.35), transparent 60%);
      border-color: rgba(108,240,255,0.45);
      box-shadow: 0 6px 18px rgba(108,240,255,0.25), inset 0 0 0 1px rgba(255,255,255,0.08);
    }
    .btn-danger {
      background:
        linear-gradient(180deg, rgba(255,77,109,0.25), rgba(255,77,109,0.12)),
        radial-gradient(400px at 50% 0%, rgba(255,77,109,0.35), transparent 60%);
      border-color: rgba(255,77,109,0.45);
      box-shadow: 0 6px 18px rgba(255,77,109,0.25), inset 0 0 0 1px rgba(255,255,255,0.08);
    }
    .btn-ok {
      background:
        linear-gradient(180deg, rgba(77,255,136,0.25), rgba(77,255,136,0.12)),
        radial-gradient(400px at 50% 0%, rgba(77,255,136,0.35), transparent 60%);
      border-color: rgba(77,255,136,0.45);
      box-shadow: 0 6px 18px rgba(77,255,136,0.25), inset 0 0 0 1px rgba(255,255,255,0.08);
    }

    /* -- HUD ----------------------------------------------------------------- */
    .hud {
      position: fixed; top: 12px; left: 12px; right: 12px;
      display: grid; grid-template-columns: 1fr auto auto auto auto auto; gap: 12px; z-index: 10;
    }
    .hud-item {
      background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--hud-radius); padding: 10px 14px;
      box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      display: flex; align-items: center; gap: 10px; animation: hudGlow 6s ease-in-out infinite;
    }
    @keyframes hudGlow {
      0% { box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); }
      50% { box-shadow: var(--glow-strong), inset 0 0 0 1px rgba(255,255,255,0.08); }
      100% { box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); }
    }
    .hud-label { font-size: 12px; color: var(--muted); letter-spacing: 0.4px; }
    .hud-value { font-size: 16px; font-weight: 800; letter-spacing: 0.6px; color: var(--text); text-shadow: var(--glow); }

    /* -- Canvas -------------------------------------------------------------- */
    #fxCanvas { position: absolute; inset: 0; width: 100%; height: 100%; display: block; z-index: 1; animation: canvasPulse 10s ease-in-out infinite; pointer-events: none; }
    @keyframes canvasPulse { 0%{filter:saturate(1) contrast(1);} 50%{filter:saturate(1.1) contrast(1.05);} 100%{filter:saturate(1) contrast(1);} }

    /* -- Screens ------------------------------------------------------------- */
    .screen { position: absolute; inset: 0; display: grid; place-items: center; z-index: 5; pointer-events: none; }
    .screen-content { pointer-events: auto; width: min(1100px, 92vw); max-height: 80vh; overflow: auto; }
    .screen-hidden { display: none; }

    /* -- Loading Screen ------------------------------------------------------ */
    .loading-logo {
      font-size: 42px; font-weight: 900; letter-spacing: 1px; text-shadow: var(--glow-strong);
      background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3)); -webkit-background-clip: text; background-clip: text; color: transparent;
      animation: logoBreath 4s ease-in-out infinite;
    }
    @keyframes logoBreath { 0%{filter:brightness(1); transform:scale(1);} 50%{filter:brightness(1.15); transform:scale(1.04);} 100%{filter:brightness(1); transform:scale(1);} }
    .loading-bar { width: 100%; height: 12px; border-radius: 999px; background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid var(--glass-border); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 6px 18px var(--shadow); overflow: hidden; margin-top: 16px; }
    .loading-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3)), radial-gradient(400px at 50% 50%, rgba(255,255,255,0.25), transparent 60%); animation: loadingFill 3s ease-in-out infinite; }
    @keyframes loadingFill { 0%{width:0%;} 50%{width:70%;} 100%{width:100%;} }

    /* -- Main Menu ----------------------------------------------------------- */
    .menu-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; }
    .menu-hero {
      background: var(--panel-gradient), var(--panel-radial);
      border: 1px solid var(--glass-border); border-radius: var(--panel-radius); padding: 24px;
      box-shadow: 0 10px 30px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); animation: heroPulse 8s ease-in-out infinite;
    }
    @keyframes heroPulse { 0%{filter:brightness(1);} 50%{filter:brightness(1.08);} 100%{filter:brightness(1);} }
    .menu-actions { display: grid; gap: 12px; }

    /* -- Bakery Layout ------------------------------------------------------- */
    .bakery-layout {
      display: grid; grid-template-columns: 1fr 0.8fr; gap: 16px;
    }
    .bakery-left, .bakery-right {
      background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--panel-radius); padding: 16px;
      box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    }

    /* -- Big Biscuit --------------------------------------------------------- */
    .big-biscuit {
      width: 280px; height: 280px; border-radius: 50%;
      background:
        radial-gradient(120px at 40% 40%, rgba(255,255,255,0.18), transparent 60%),
        radial-gradient(120px at 60% 60%, rgba(255,255,255,0.12), transparent 60%),
        conic-gradient(from 0deg, #a86a44, #8d5a3a, #a86a44);
      border: 8px solid rgba(255,255,255,0.12);
      box-shadow: 0 10px 30px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06);
      display: grid; place-items: center; margin: 0 auto;
      cursor: pointer; user-select: none;
      animation: biscuitIdle 6s ease-in-out infinite;
      position: relative;
    }
    @keyframes biscuitIdle { 0%{transform:translateY(0) rotate(0deg);} 50%{transform:translateY(-4px) rotate(1deg);} 100%{transform:translateY(0) rotate(0deg);} }
    .biscuit-face {
      width: 70%; height: 70%; border-radius: 50%;
      background:
        radial-gradient(60px at 50% 30%, rgba(0,0,0,0.12), transparent 60%),
        radial-gradient(60px at 50% 70%, rgba(0,0,0,0.12), transparent 60%);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.08);
    }
    .biscuit-click {
      animation: biscuitClick 0.2s ease;
    }
    @keyframes biscuitClick { 0%{transform:scale(1);} 50%{transform:scale(0.96);} 100%{transform:scale(1);} }

    /* -- Production Stats ---------------------------------------------------- */
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .stat-card {
      background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--hud-radius); padding: 12px;
      box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .stat-title { font-size: 12px; color: var(--muted); }
    .stat-value { font-size: 16px; font-weight: 800; letter-spacing: 0.6px; color: var(--text); text-shadow: var(--glow); }

    /* -- Building List ------------------------------------------------------- */
    .building-list { display: grid; gap: 10px; }
    .building {
      display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;
      background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--hud-radius); padding: 12px;
      box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .building-title { font-weight: 800; letter-spacing: 0.6px; }
    .building-desc { font-size: 12px; color: var(--muted); }
    .building-controls { display: inline-flex; gap: 8px; }

    /* -- Research ------------------------------------------------------------ */
    .research-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .research-card {
      background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--panel-radius); padding: 16px;
      box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); display: grid; gap: 8px;
    }
    .research-title { font-weight: 800; letter-spacing: 0.6px; }
    .research-desc { font-size: 12px; color: var(--muted); }
    .research-cost { font-size: 14px; font-weight: 700; color: var(--accent); }

    /* -- Prestige ------------------------------------------------------------ */
    .prestige-panel {
      background: var(--panel-gradient), var(--ok-radial);
      border: 1px solid var(--glass-border); border-radius: var(--panel-radius); padding: 24px;
      box-shadow: 0 10px 30px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); animation: prestigePulse 8s ease-in-out infinite;
    }
    @keyframes prestigePulse { 0%{filter:brightness(1);} 50%{filter:brightness(1.1);} 100%{filter:brightness(1);} }

    /* -- Achievements -------------------------------------------------------- */
    .achievements-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .achievement {
      background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--panel-radius); padding: 16px;
      box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); display: grid; gap: 8px;
    }
    .achievement.unlocked { border-color: rgba(77,255,136,0.45); box-shadow: 0 0 12px rgba(77,255,136,0.6), 0 0 24px rgba(77,255,136,0.3); }
    .achievement-title { font-weight: 800; letter-spacing: 0.6px; }
    .achievement-desc { font-size: 12px; color: var(--muted); }

    /* -- Settings ------------------------------------------------------------ */
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .setting-item { display: grid; gap: 8px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--panel-radius); padding: 16px; }

    /* -- Admin Console ------------------------------------------------------- */
    .admin-console {
      background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--panel-radius); padding: 16px;
      box-shadow: 0 10px 30px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .admin-field { display: grid; gap: 6px; }
    .admin-input { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.06); color: var(--text); }
    .admin-log { height: 160px; overflow: auto; background: rgba(0,0,0,0.35); border-radius: 12px; padding: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* -- Game Over ----------------------------------------------------------- */
    .gameover-panel {
      background: var(--panel-gradient), var(--danger-radial);
      border: 1px solid var(--glass-border); border-radius: var(--panel-radius); padding: 24px;
      box-shadow: 0 10px 30px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); animation: gameOverPulse 8s ease-in-out infinite;
    }
    @keyframes gameOverPulse { 0%{filter:brightness(1);} 50%{filter:brightness(1.1);} 100%{filter:brightness(1);} }
    .gameover-title { font-size: 32px; font-weight: 900; letter-spacing: 1px; color: var(--danger); text-shadow: 0 0 12px rgba(255,77,109,0.6), 0 0 24px rgba(255,77,109,0.3); animation: shakeSoft 2.2s ease-in-out infinite; }

    /* -- Pause Overlay ------------------------------------------------------- */
    .pause-overlay { position: absolute; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,0.35); z-index: 8; }
    .pause-content { width: min(600px, 92vw); background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--panel-radius); padding: 24px; box-shadow: 0 10px 30px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); }

    /* -- Screen Shakes ------------------------------------------------------- */
    .shake-hard { animation: shakeHard 0.6s cubic-bezier(.36,.07,.19,.97) both; }
    .shake-soft { animation: shakeSoft 1.2s ease-in-out both; }
    @keyframes shakeHard { 10%,90%{transform:translate3d(-1px,0,0);} 20%,80%{transform:translate3d(2px,0,0);} 30%,50%,70%{transform:translate3d(-4px,0,0);} 40%,60%{transform:translate3d(4px,0,0);} }
    @keyframes shakeSoft { 0%{transform:translate3d(0,0,0);} 25%{transform:translate3d(1px,-1px,0);} 50%{transform:translate3d(-1px,1px,0);} 75%{transform:translate3d(1px,1px,0);} 100%{transform:translate3d(0,0,0);} }

    /* -- Glow Pulses --------------------------------------------------------- */
    .glow-pulse { animation: glowPulse 2.4s ease-in-out infinite; }
    @keyframes glowPulse { 0%{box-shadow:var(--glow);} 50%{box-shadow:var(--glow-strong);} 100%{box-shadow:var(--glow);} }

    /* -- Tooltip ------------------------------------------------------------- */
    .tooltip { position: absolute; background: rgba(0,0,0,0.6); color: #fff; padding: 6px 10px; border-radius: 8px; font-size: 12px; pointer-events: none; transform: translate(-50%, -120%); white-space: nowrap; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 6px 18px var(--shadow); animation: tooltipFade 0.25s ease-out; }
    @keyframes tooltipFade { from{opacity:0; transform:translate(-50%,-140%);} to{opacity:1; transform:translate(-50%,-120%);} }

    /* -- Progress Ring ------------------------------------------------------- */
    .ring { width: 64px; height: 64px; border-radius: 50%; border: 6px solid rgba(255,255,255,0.12); border-top-color: var(--accent); animation: spin 1.2s linear infinite; }
    @keyframes spin { to{transform:rotate(360deg);} }

    /* -- Decorative Lines ---------------------------------------------------- */
    .divider { height: 1px; background: linear-gradient(90deg, rgba(255,255,255,0.08), rgba(255,255,255,0.2), rgba(255,255,255,0.08)); margin: 12px 0; }

    /* -- Badge --------------------------------------------------------------- */
    .badge {
      display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 800; letter-spacing: 0.6px; color: var(--text);
      border: 1px solid var(--glass-border);
      background: var(--panel-gradient), radial-gradient(400px at 50% 50%, rgba(108,240,255,0.18), transparent 60%);
      box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); animation: badgePulse 5s ease-in-out infinite;
    }
    @keyframes badgePulse { 0%{filter:brightness(1);} 50%{filter:brightness(1.08);} 100%{filter:brightness(1);} }

    /* -- Modal --------------------------------------------------------------- */
    .modal { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,0.35); z-index: 20; animation: modalFade 0.25s ease-out; }
    .modal-content { width: min(720px, 92vw); background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--panel-radius); padding: 24px; box-shadow: 0 10px 30px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); animation: modalPulse 6s ease-in-out infinite; }
    @keyframes modalFade { from{opacity:0;} to{opacity:1;} }
    @keyframes modalPulse { 0%{filter:brightness(1);} 50%{filter:brightness(1.06);} 100%{filter:brightness(1);} }

    /* -- Floating Action ----------------------------------------------------- */
    .fab {
      position: fixed; bottom: 16px; right: 16px; width: 56px; height: 56px; border-radius: 50%; display: grid; place-items: center;
      background: linear-gradient(180deg, rgba(108,240,255,0.25), rgba(108,240,255,0.12)), radial-gradient(400px at 50% 0%, rgba(108,240,255,0.35), transparent 60%);
      border: 1px solid rgba(108,240,255,0.45); box-shadow: 0 10px 24px rgba(108,240,255,0.25), inset 0 0 0 1px rgba(255,255,255,0.08);
      cursor: pointer; z-index: 12; animation: fabPulse 4s ease-in-out infinite;
    }
    @keyframes fabPulse { 0%{transform:translateY(0);} 50%{transform:translateY(-4px);} 100%{transform:translateY(0);} }

    /* -- Notification -------------------------------------------------------- */
    .toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--hud-radius); padding: 10px 14px; box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: var(--text); z-index: 12; animation: toastFade 0.25s ease-out, toastPulse 6s ease-in-out infinite; }
    @keyframes toastFade { from{opacity:0; transform:translate(-50%, 20px);} to{opacity:1; transform:translate(-50%, 0);} }
    @keyframes toastPulse { 0%{filter:brightness(1);} 50%{filter:brightness(1.06);} 100%{filter:brightness(1);} }

    /* -- Progress Bars ------------------------------------------------------- */
    .progress { width: 100%; height: 10px; border-radius: 999px; background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid var(--glass-border); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 6px 18px var(--shadow); overflow: hidden; }
    .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3)), radial-gradient(400px at 50% 50%, rgba(255,255,255,0.25), transparent 60%); animation: progressFill 2.2s ease-in-out infinite; }
    @keyframes progressFill { 0%{width:10%;} 50%{width:70%;} 100%{width:90%;} }

    /* -- Meter --------------------------------------------------------------- */
    .meter { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; }
    .meter-dot { width: 10px; height: 10px; border-radius: 50%; background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); border: 1px solid var(--glass-border); box-shadow: 0 6px 18px var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.06); animation: dotPulse 3s ease-in-out infinite; }
    @keyframes dotPulse { 0%{filter:brightness(1);} 50%{filter:brightness(1.2);} 100%{filter:brightness(1);} }

    /* -- Label --------------------------------------------------------------- */
    .label { font-size: 12px; color: var(--muted); }

    /* -- Scrollbars ---------------------------------------------------------- */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.06); border-radius: 999px; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(108,240,255,0.35), rgba(108,240,255,0.18)); border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); }

    /* -- Credits ------------------------------------------------------------- */
    .credits { font-size: 12px; color: var(--muted); text-align: center; margin-top: 8px; }

    /* -- Telegraph ----------------------------------------------------------- */
    .telegraph {
      position: absolute; border: 2px dashed var(--ring-color); border-radius: 50%;
      animation: telegraphPulse 1.2s ease-in-out infinite;
    }
    @keyframes telegraphPulse { 0%{opacity:0.4;} 50%{opacity:0.8;} 100%{opacity:0.4;} }

    /* -- Heat Haze ----------------------------------------------------------- */
    .heat-haze {
      position: absolute; inset: 0; pointer-events: none; z-index: 2;
      background: radial-gradient(600px at 50% 50%, rgba(255,255,255,0.03), transparent 60%);
      mix-blend-mode: screen; animation: hazePulse 8s ease-in-out infinite;
    }
    @keyframes hazePulse { 0%{opacity:0.05;} 50%{opacity:0.12;} 100%{opacity:0.05;} }

    /* -- Ribbons ------------------------------------------------------------- */
    .ribbon {
      display: inline-block; padding: 6px 12px; border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.08));
      border: 1px solid rgba(255,255,255,0.22); box-shadow: 0 6px 18px var(--shadow);
      font-weight: 800; letter-spacing: 0.6px; color: var(--text);
      animation: ribbonPulse 6s ease-in-out infinite;
    }
    @keyframes ribbonPulse { 0%{filter:brightness(1);} 50%{filter:brightness(1.06);} 100%{filter:brightness(1);} }

    /* -- Golden Biscuit ------------------------------------------------------ */
    .golden {
      position: absolute; width: 48px; height: 48px; border-radius: 50%;
      background:
        radial-gradient(20px at 50% 50%, rgba(255,255,255,0.35), transparent 60%),
        conic-gradient(from 0deg, #ffd166, #ffb703, #ffd166);
      border: 2px solid rgba(255,255,255,0.25);
      box-shadow: 0 10px 24px rgba(255,209,102,0.35);
      animation: goldenPulse 1.6s ease-in-out infinite;
      cursor: pointer;
    }
    @keyframes goldenPulse { 0%{transform:scale(1);} 50%{transform:scale(1.12);} 100%{transform:scale(1);} }

    /* -- End of 300+ lines CSS ---------------------------------------------- */
  </style>
</head>
<body>
  <div class="bg-layer"></div>
  <div class="heat-haze"></div>

  <!-- HUD -->
  <div class="hud">
    <div class="hud-item">
      <div class="hud-label">Biscuits</div>
      <div class="hud-value" id="hudBiscuits">0</div>
    </div>
    <div class="hud-item">
      <div class="hud-label">B/s</div>
      <div class="hud-value" id="hudBps">0</div>
    </div>
    <div class="hud-item">
      <div class="hud-label">Prestige</div>
      <div class="hud-value" id="hudPrestige">0</div>
    </div>
    <div class="hud-item">
      <div class="hud-label">Golden</div>
      <div class="hud-value" id="hudGolden">0</div>
    </div>
    <div class="hud-item">
      <div class="hud-label">Seed</div>
      <div class="hud-value" id="hudSeed">—</div>
    </div>
    <div class="hud-item">
      <div class="hud-label">Admin</div>
      <div class="hud-value" id="hudAdmin">Locked</div>
    </div>
  </div>

  <!-- FX Canvas -->
  <canvas id="fxCanvas"></canvas>

  <!-- Screens -->
  <div class="screen" id="screenLoading">
    <div class="screen-content panel">
      <div class="panel-title loading-logo">Quantum Bakery</div>
      <div class="divider"></div>
      <div class="loading-bar"><div class="loading-fill" id="loadingFill"></div></div>
      <div class="credits">Preheating ovens, tempering chocolate, compiling synths…</div>
    </div>
  </div>

  <div class="screen screen-hidden" id="screenMenu">
    <div class="screen-content panel">
      <div class="panel-title">Main Menu</div>
      <div class="menu-grid">
        <div class="menu-hero">
          <div class="badge">Insane Clicker Forge</div>
          <div class="divider"></div>
          <p class="label">Matteo, this is a brand-new bakery—fresh engine, deeper systems, and an Admin vault.</p>
          <div class="meter">
            <div class="meter-dot"></div><div class="meter-dot"></div><div class="meter-dot"></div><div class="meter-dot"></div><div class="meter-dot"></div>
            <div class="meter-dot"></div><div class="meter-dot"></div><div class="meter-dot"></div><div class="meter-dot"></div><div class="meter-dot"></div>
          </div>
        </div>
        <div class="menu-actions">
          <button class="btn btn-primary" id="btnStart">Start Baking</button>
          <button class="btn" id="btnFactory">Factory</button>
          <button class="btn" id="btnResearch">Research</button>
          <button class="btn" id="btnPrestige">Prestige</button>
          <button class="btn" id="btnAchievements">Achievements</button>
          <button class="btn" id="btnSettings">Settings</button>
          <button class="btn btn-danger" id="btnAdmin">Admin Console</button>
        </div>
      </div>
      <div class="credits">No libraries. No shortcuts. Just raw code and sugar rush.</div>
    </div>
  </div>

  <div class="screen screen-hidden" id="screenBakery">
    <div class="screen-content panel">
      <div class="panel-title">Bakery</div>
      <div class="bakery-layout">
        <div class="bakery-left">
          <div class="big-biscuit" id="bigBiscuit">
            <div class="biscuit-face"></div>
          </div>
          <div class="stat-grid">
            <div class="stat-card">
              <div class="stat-title">Total Biscuits</div>
              <div class="stat-value" id="statTotal">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Clicks</div>
              <div class="stat-value" id="statClicks">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Session Time</div>
              <div class="stat-value" id="statTime">0s</div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="label">Golden biscuits may spawn randomly—click them fast for massive boosts.</div>
        </div>
        <div class="bakery-right">
          <div class="panel-title">Buildings</div>
          <div class="building-list" id="buildingList"></div>
          <div class="divider"></div>
          <button class="btn" id="btnBackFromBakery">Back</button>
        </div>
      </div>
    </div>
  </div>

  <div class="screen screen-hidden" id="screenFactory">
    <div class="screen-content panel">
      <div class="panel-title">Factory</div>
      <p class="label">Automate production with industrial-grade upgrades and synergy modules.</p>
      <div class="building-list" id="factoryList"></div>
      <div class="divider"></div>
      <button class="btn" id="btnBackFromFactory">Back</button>
    </div>
  </div>

  <div class="screen screen-hidden" id="screenResearch">
    <div class="screen-content panel">
      <div class="panel-title">Research</div>
      <p class="label">Unlock permanent tech: better ovens, quantum yeast, and flavor entanglement.</p>
      <div class="research-grid" id="researchGrid"></div>
      <div class="divider"></div>
      <button class="btn" id="btnBackFromResearch">Back</button>
    </div>
  </div>

  <div class="screen screen-hidden" id="screenPrestige">
    <div class="screen-content prestige-panel">
      <div class="panel-title">Prestige</div>
      <p class="label">Ascend to earn Prestige Crumbs—permanent multipliers and special mechanics.</p>
      <div class="divider"></div>
      <div class="menu-actions">
        <button class="btn btn-primary" id="btnAscend">Ascend</button>
        <button class="btn" id="btnBackFromPrestige">Back</button>
      </div>
    </div>
  </div>

  <div class="screen screen-hidden" id="screenAchievements">
    <div class="screen-content panel">
      <div class="panel-title">Achievements</div>
      <div class="achievements-grid" id="achievementsGrid"></div>
      <div class="divider"></div>
      <button class="btn" id="btnBackFromAchievements">Back</button>
    </div>
  </div>

  <div class="screen screen-hidden" id="screenSettings">
    <div class="screen-content panel">
      <div class="panel-title">Settings</div>
      <div class="settings-grid">
        <div class="setting-item">
          <div class="research-title">Audio Volume</div>
          <input type="range" min="0" max="1" step="0.01" id="volumeSlider"/>
          <div class="label">Adjust master volume for procedural audio.</div>
        </div>
        <div class="setting-item">
          <div class="research-title">Reduced Motion</div>
          <button class="btn" id="btnReducedMotion">Toggle</button>
          <div class="label">Disables certain animations and shakes.</div>
        </div>
        <div class="setting-item">
          <div class="research-title">Colorblind Mode</div>
          <button class="btn" id="btnColorblind">Toggle</button>
          <div class="label">Adjusts palettes for better differentiation.</div>
        </div>
        <div class="setting-item">
          <div class="research-title">Performance Mode</div>
          <button class="btn" id="btnPerf">Toggle</button>
          <div class="label">Reduces particle cap and effects for FPS stability.</div>
        </div>
        <div class="setting-item">
          <div class="research-title">Seed</div>
          <div class="seed-panel">
            <input class="admin-input" id="seedInput" placeholder="Enter seed (alphanumeric)"/>
            <button class="btn btn-primary" id="btnApplySeed">Apply</button>
          </div>
          <div class="label">Seeds control golden spawns, storms, and synergy rolls.</div>
        </div>
        <div class="setting-item">
          <div class="research-title">Debug Draw</div>
          <button class="btn" id="btnDebugParticles">Particles</button>
          <button class="btn" id="btnDebugAudio">Audio Scope</button>
          <button class="btn" id="btnDebugPerf">Perf Stats</button>
          <div class="label">Visualize internals for validation.</div>
        </div>
      </div>
      <div class="divider"></div>
      <button class="btn" id="btnBackFromSettings">Back</button>
    </div>
  </div>

  <div class="screen screen-hidden" id="screenAdmin">
    <div class="screen-content panel">
      <div class="panel-title">Admin Console</div>
      <div class="admin-console">
        <div class="admin-grid">
          <div class="admin-field">
            <label class="label">Password</label>
            <input class="admin-input" id="adminPassword" type="password" placeholder="Enter Admin Password"/>
            <button class="btn btn-danger" id="btnUnlockAdmin">Unlock</button>
            <div class="label">Admin password is case-sensitive.</div>
          </div>
          <div class="admin-field">
            <label class="label">Admin Actions</label>
            <div class="building-controls">
              <button class="btn" id="btnAdminGive1e6">Give 1e6 Biscuits</button>
              <button class="btn" id="btnAdminMaxUpgrades">Max Upgrades</button>
              <button class="btn" id="btnAdminSpawnGolden">Spawn Golden</button>
              <button class="btn btn-danger" id="btnAdminWipe">Wipe Save</button>
            </div>
            <div class="label">Actions require unlocked Admin mode.</div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="admin-log" id="adminLog"></div>
      </div>
      <div class="divider"></div>
      <button class="btn" id="btnBackFromAdmin">Back</button>
    </div>
  </div>

  <div class="screen screen-hidden" id="screenGameOver">
    <div class="screen-content gameover-panel">
      <div class="gameover-title">Game Over</div>
      <div class="divider"></div>
      <p class="label">The ovens cooled. Your biscuits and prestige are tallied below.</p>
      <div class="divider"></div>
      <div class="menu-actions">
        <button class="btn btn-primary" id="btnRetry">Retry</button>
        <button class="btn" id="btnReturnMenu">Return to Menu</button>
      </div>
    </div>
  </div>

  <!-- Pause Overlay -->
  <div class="pause-overlay screen-hidden" id="pauseOverlay">
    <div class="pause-content panel">
      <div class="panel-title">Paused</div>
      <div id="pauseStats" class="label">—</div>
      <div class="menu-actions">
        <button class="btn btn-primary" id="btnResume">Resume</button>
        <button class="btn" id="btnPauseMenu">Menu</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast screen-hidden" id="toast"></div>

  <script>
    "use strict";
    /* =========================================================================
       Quantum Bakery — Insane Clicker Forge
       =========================================================================
       This script implements a complete clicker game with:
       - State machine for screens and flow.
       - Production systems: buildings, factory modules, research tech, prestige.
       - Particle system for click juice and events.
       - Procedural audio via Web Audio API.
       - Admin mode gated by password "Admin123123".
       - Save system with versioning and migration.
       - Debug overlays and performance stats.
       - Verbose comments for every function and variable.

       NOTE: If we hit a character limit, say “Continue” to resume the file.
    */

    /* -------------------------------------------------------------------------
       Global Constants
       ------------------------------------------------------------------------- */
    /** Game version string used for save compatibility and migrations. */
    const GAME_VERSION = "1.0.0-quantum-bakery";
    /** Admin password required to unlock admin console actions. */
    const ADMIN_PASSWORD = "Admin123123";
    /** Default seed used when none is provided. */
    const DEFAULT_SEED = "BAKERY-SEED-001";
    /** Target FPS for logic pacing; rendering is requestAnimationFrame-driven. */
    const TARGET_FPS = 60;
    /** Milliseconds per tick derived from target FPS. */
    const MS_PER_TICK = 1000 / TARGET_FPS;
    /** Maximum particles allowed in normal mode; performance mode reduces this. */
    const MAX_PARTICLES = 1200;
    /** Maximum particles in performance mode. */
    const MAX_PARTICLES_PERF = 600;
    /** Golden biscuit spawn interval range in milliseconds. */
    const GOLDEN_MIN_MS = 15000;
    const GOLDEN_MAX_MS = 45000;

    /* -------------------------------------------------------------------------
       DOM References
       ------------------------------------------------------------------------- */
    // HUD elements
    const hudBiscuitsEl = document.getElementById("hudBiscuits");
    const hudBpsEl = document.getElementById("hudBps");
    const hudPrestigeEl = document.getElementById("hudPrestige");
    const hudGoldenEl = document.getElementById("hudGolden");
    const hudSeedEl = document.getElementById("hudSeed");
    const hudAdminEl = document.getElementById("hudAdmin");

    // Screens
    const screenLoading = document.getElementById("screenLoading");
    const screenMenu = document.getElementById("screenMenu");
    const screenBakery = document.getElementById("screenBakery");
    const screenFactory = document.getElementById("screenFactory");
    const screenResearch = document.getElementById("screenResearch");
    const screenPrestige = document.getElementById("screenPrestige");
    const screenAchievements = document.getElementById("screenAchievements");
    const screenSettings = document.getElementById("screenSettings");
    const screenAdmin = document.getElementById("screenAdmin");
    const screenGameOver = document.getElementById("screenGameOver");
    const pauseOverlay = document.getElementById("pauseOverlay");

    // Menu buttons
    const btnStart = document.getElementById("btnStart");
    const btnFactory = document.getElementById("btnFactory");
    const btnResearch = document.getElementById("btnResearch");
    const btnPrestige = document.getElementById("btnPrestige");
    const btnAchievements = document.getElementById("btnAchievements");
    const btnSettings = document.getElementById("btnSettings");
    const btnAdmin = document.getElementById("btnAdmin");

    // Bakery
    const bigBiscuit = document.getElementById("bigBiscuit");
    const buildingList = document.getElementById("buildingList");
    const btnBackFromBakery = document.getElementById("btnBackFromBakery");
    const statTotalEl = document.getElementById("statTotal");
    const statClicksEl = document.getElementById("statClicks");
    const statTimeEl = document.getElementById("statTime");

    // Factory
    const factoryList = document.getElementById("factoryList");
    const btnBackFromFactory = document.getElementById("btnBackFromFactory");

    // Research
    const researchGrid = document.getElementById("researchGrid");
    const btnBackFromResearch = document.getElementById("btnBackFromResearch");

    // Prestige
    const btnAscend = document.getElementById("btnAscend");
    const btnBackFromPrestige = document.getElementById("btnBackFromPrestige");

    // Achievements
    const achievementsGrid = document.getElementById("achievementsGrid");
    const btnBackFromAchievements = document.getElementById("btnBackFromAchievements");

    // Settings
    const volumeSlider = document.getElementById("volumeSlider");
    const btnReducedMotion = document.getElementById("btnReducedMotion");
    const btnColorblind = document.getElementById("btnColorblind");
    const btnPerf = document.getElementById("btnPerf");
    const seedInput = document.getElementById("seedInput");
    const btnApplySeed = document.getElementById("btnApplySeed");
    const btnDebugParticles = document.getElementById("btnDebugParticles");
    const btnDebugAudio = document.getElementById("btnDebugAudio");
    const btnDebugPerf = document.getElementById("btnDebugPerf");
    const btnBackFromSettings = document.getElementById("btnBackFromSettings");

    // Admin
    const adminPasswordInput = document.getElementById("adminPassword");
    const btnUnlockAdmin = document.getElementById("btnUnlockAdmin");
    const btnAdminGive1e6 = document.getElementById("btnAdminGive1e6");
    const btnAdminMaxUpgrades = document.getElementById("btnAdminMaxUpgrades");
    const btnAdminSpawnGolden = document.getElementById("btnAdminSpawnGolden");
    const btnAdminWipe = document.getElementById("btnAdminWipe");
    const btnBackFromAdmin = document.getElementById("btnBackFromAdmin");
    const adminLog = document.getElementById("adminLog");

    // Game Over
    const btnRetry = document.getElementById("btnRetry");
    const btnReturnMenu = document.getElementById("btnReturnMenu");

    // Pause
    const btnResume = document.getElementById("btnResume");
    const btnPauseMenu = document.getElementById("btnPauseMenu");
    const pauseStats = document.getElementById("pauseStats");

    // Toast
    const toastEl = document.getElementById("toast");

    // FX Canvas
    const fxCanvas = document.getElementById("fxCanvas");
    const fxCtx = fxCanvas.getContext("2d");

    /* -------------------------------------------------------------------------
       Utility Functions
       ------------------------------------------------------------------------- */
    /** Clamp a number between min and max. */
    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
    /** Linear interpolation between a and b by t. */
    function lerp(a, b, t) { return a + (b - a) * t; }
    /** Random float in [min, max). */
    function randf(min, max) { return Math.random() * (max - min) + min; }
    /** Random integer in [min, max]. */
    function randi(min, max) { return Math.floor(randf(min, max + 1)); }
    /** Returns a seeded pseudo-random generator function. */
    function makePRNG(seedStr) {
      // Simple xorshift32 seeded by string hash.
      let h = 2166136261 >>> 0;
      for (let i = 0; i < seedStr.length; i++) {
        h ^= seedStr.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      let x = h || 123456789;
      return function() {
        // xorshift32
        x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
        // Convert to [0,1)
        return ((x >>> 0) / 4294967296);
      };
    }
    /** Formats large numbers with suffixes (K, M, B, T, Qa, Qi...). */
    function formatNum(n) {
      const abs = Math.abs(n);
      const suffixes = ["", "K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "De"];
      let idx = 0;
      while (abs >= 1000 && idx < suffixes.length - 1) { n /= 1000; idx++; }
      return (n.toFixed(n >= 100 ? 0 : n >= 10 ? 1 : 2)) + suffixes[idx];
    }
    /** Shows a toast message with optional danger styling. */
    function showToast(msg, danger = false) {
      toastEl.textContent = msg;
      toastEl.classList.remove("screen-hidden");
      toastEl.style.borderColor = danger ? "rgba(255,77,109,0.45)" : "var(--glass-border)";
      setTimeout(() => toastEl.classList.add("screen-hidden"), 2000);
    }
    /** Appends a line to the admin log. */
    function adminLogLine(text) {
      const time = new Date().toLocaleTimeString();
      adminLog.innerHTML += `<div>[${time}] ${text}</div>`;
      adminLog.scrollTop = adminLog.scrollHeight;
    }

    /* -------------------------------------------------------------------------
       State Machine
       ------------------------------------------------------------------------- */
    /** Enumeration of game states. */
    const State = {
      LOADING: "LOADING",
      MENU: "MENU",
      BAKERY: "BAKERY",
      FACTORY: "FACTORY",
      RESEARCH: "RESEARCH",
      PRESTIGE: "PRESTIGE",
      ACHIEVEMENTS: "ACHIEVEMENTS",
      SETTINGS: "SETTINGS",
      ADMIN: "ADMIN",
      GAMEOVER: "GAMEOVER",
      PAUSED: "PAUSED",
    };
    /** Current state of the game. */
    let currentState = State.LOADING;

    /** Shows only the screen corresponding to the given state. */
    function setState(state) {
      currentState = state;
      // Hide all screens
      [screenLoading, screenMenu, screenBakery, screenFactory, screenResearch, screenPrestige, screenAchievements, screenSettings, screenAdmin, screenGameOver].forEach(s => s.classList.add("screen-hidden"));
      pauseOverlay.classList.add("screen-hidden");
      // Show target
      switch (state) {
        case State.LOADING: screenLoading.classList.remove("screen-hidden"); break;
        case State.MENU: screenMenu.classList.remove("screen-hidden"); break;
        case State.BAKERY: screenBakery.classList.remove("screen-hidden"); break;
        case State.FACTORY: screenFactory.classList.remove("screen-hidden"); break;
        case State.RESEARCH: screenResearch.classList.remove("screen-hidden"); break;
        case State.PRESTIGE: screenPrestige.classList.remove("screen-hidden"); break;
        case State.ACHIEVEMENTS: screenAchievements.classList.remove("screen-hidden"); break;
        case State.SETTINGS: screenSettings.classList.remove("screen-hidden"); break;
        case State.ADMIN: screenAdmin.classList.remove("screen-hidden"); break;
        case State.GAMEOVER: screenGameOver.classList.remove("screen-hidden"); break;
        case State.PAUSED: pauseOverlay.classList.remove("screen-hidden"); break;
      }
    }

    /* -------------------------------------------------------------------------
       Save System
       ------------------------------------------------------------------------- */
    /** Key used in localStorage for the save data. */
    const SAVE_KEY = "quantum-bakery-save";
    /** Default save structure. */
    const defaultSave = {
      version: GAME_VERSION,
      seed: DEFAULT_SEED,
      biscuits: 0,
      totalBiscuits: 0,
      clicks: 0,
      goldenCount: 0,
      prestige: 0,
      prestigeCrumbs: 0,
      buildings: {}, // id -> count
      factoryUpgrades: {}, // id -> level
      research: {}, // id -> unlocked
      achievements: {}, // id -> unlocked
      settings: {
        volume: 0.6,
        reducedMotion: false,
        colorblind: false,
        performance: false,
        debugParticles: false,
        debugAudio: false,
        debugPerf: false,
      },
      adminUnlocked: false,
      lastSessionStart: Date.now(),
    };
    /** Current save data in memory. */
    let save = null;

    /** Loads save from localStorage, migrates if needed, else default. */
    function loadSave() {
      try {
        const raw = localStorage.getItem(SAVE_KEY);
        if (!raw) {
          save = JSON.parse(JSON.stringify(defaultSave));
          return;
        }
        const data = JSON.parse(raw);
        // Migration example: if version mismatch, merge defaults
        if (!data.version || data.version !== GAME_VERSION) {
          save = Object.assign({}, defaultSave, data);
          save.version = GAME_VERSION;
        } else {
          save = data;
        }
      } catch (e) {
        console.error("Failed to load save:", e);
        save = JSON.parse(JSON.stringify(defaultSave));
      }
    }
    /** Persists save to localStorage. */
    function writeSave() {
      try {
        localStorage.setItem(SAVE_KEY, JSON.stringify(save));
      } catch (e) {
        console.error("Failed to write save:", e);
      }
    }
    /** Wipes save and reloads defaults. */
    function wipeSave() {
      localStorage.removeItem(SAVE_KEY);
      loadSave();
      writeSave();
    }

    /* -------------------------------------------------------------------------
       Audio Manager (Procedural Web Audio API)
       ------------------------------------------------------------------------- */
    /** Audio context used for all procedural sounds. */
    let audioCtx = null;
    /** Master gain node controlling overall volume. */
    let masterGain = null;
    /** Analyser node for debug audio scope. */
    let analyser = null;

    /** Initializes audio context and nodes. */
    function initAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = save.settings.volume;
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      masterGain.connect(analyser);
      analyser.connect(audioCtx.destination);
    }
    /** Sets master volume. */
    function setVolume(v) {
      if (!masterGain) return;
      masterGain.gain.value = clamp(v, 0, 1);
    }
    /** Plays a short click blip. */
    function playClick() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "square";
      osc.frequency.value = 220 + Math.random() * 80;
      gain.gain.setValueAtTime(0.0, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.12);
      osc.connect(gain).connect(masterGain);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.15);
    }
    /** Plays a purchase tone. */
    function playPurchase() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "triangle";
      osc.frequency.setValueAtTime(440, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(660, audioCtx.currentTime + 0.2);
      gain.gain.setValueAtTime(0.0, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0.25, audioCtx.currentTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.4);
      osc.connect(gain).connect(masterGain);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.45);
    }
    /** Plays an error buzz. */
    function playError() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sawtooth";
      osc.frequency.setValueAtTime(180, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(120, audioCtx.currentTime + 0.2);
      gain.gain.setValueAtTime(0.0, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0.25, audioCtx.currentTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.4);
      osc.connect(gain).connect(masterGain);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.45);
    }
    /** Plays a prestige fanfare. */
    function playPrestige() {
      if (!audioCtx) return;
      const osc1 = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc1.type = "sine"; osc2.type = "sine";
      osc1.frequency.setValueAtTime(330, audioCtx.currentTime);
      osc2.frequency.setValueAtTime(660, audioCtx.currentTime);
      osc1.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.6);
      osc2.frequency.exponentialRampToValueAtTime(1320, audioCtx.currentTime + 0.6);
      gain.gain.setValueAtTime(0.0, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.8);
      osc1.connect(gain); osc2.connect(gain); gain.connect(masterGain);
      osc1.start(); osc2.start();
      osc1.stop(audioCtx.currentTime + 0.85);
      osc2.stop(audioCtx.currentTime + 0.85);
    }
    /** Plays admin unlock chime. */
    function playAdminUnlock() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "square";
      osc.frequency.setValueAtTime(520, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(1040, audioCtx.currentTime + 0.25);
      gain.gain.setValueAtTime(0.0, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
      osc.connect(gain).connect(masterGain);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.55);
    }

    /* -------------------------------------------------------------------------
       Particle System
       ------------------------------------------------------------------------- */
    /** Resizes FX canvas to match window. */
    function resizeCanvas() {
      fxCanvas.width = window.innerWidth;
      fxCanvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);

    /** Particle class representing a single visual effect element. */
    class Particle {
      /**
       * @param {number} x - Initial x position.
       * @param {number} y - Initial y position.
       * @param {number} vx - Initial x velocity.
       * @param {number} vy - Initial y velocity.
       * @param {string} color - Stroke/fill color.
       * @param {number} life - Lifetime in seconds.
       * @param {number} size - Base size in pixels.
       * @param {boolean} glow - Whether to draw glow.
       */
      constructor(x, y, vx, vy, color, life, size, glow = true) {
        this.x = x; this.y = y;
        this.vx = vx; this.vy = vy;
        this.color = color;
        this.life = life;
        this.age = 0;
        this.size = size;
        this.glow = glow;
        this.friction = 0.98;
        this.gravity = 0.0;
        this.spin = randf(-2, 2);
        this.alpha = 1.0;
      }
      /** Updates physics and returns whether still alive. */
      update(dt) {
        this.age += dt;
        if (this.age >= this.life) return false;
        this.vx *= this.friction;
        this.vy = this.vy * this.friction + this.gravity * dt * 60;
        this.x += this.vx * dt * 60;
        this.y += this.vy * dt * 60;
        this.alpha = 1.0 - (this.age / this.life);
        return true;
      }
      /** Renders particle to canvas. */
      draw(ctx) {
        ctx.save();
        ctx.globalAlpha = this.alpha;
        ctx.translate(this.x, this.y);
        ctx.rotate(this.spin * this.age);
        if (this.glow) {
          ctx.shadowColor = this.color;
          ctx.shadowBlur = 12;
        } else {
          ctx.shadowBlur = 0;
        }
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(0, 0, this.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      }
    }

    /** Particle system managing many particles. */
    class ParticleSystem {
      constructor() {
        this.particles = [];
        this.max = save.settings.performance ? MAX_PARTICLES_PERF : MAX_PARTICLES;
        this.debugDraw = save.settings.debugParticles;
      }
      /** Spawns a burst of particles at (x,y). */
      burst(x, y, count, color) {
        for (let i = 0; i < count; i++) {
          if (this.particles.length >= this.max) break;
          const angle = randf(0, Math.PI * 2);
          const speed = randf(1, 6);
          const vx = Math.cos(angle) * speed;
          const vy = Math.sin(angle) * speed;
          const life = randf(0.4, 1.2);
          const size = randf(2, 6);
          this.particles.push(new Particle(x, y, vx, vy, color, life, size, true));
        }
      }
      /** Spawns a stream of particles along a direction. */
      stream(x, y, dirX, dirY, count, color) {
        for (let i = 0; i < count; i++) {
          if (this.particles.length >= this.max) break;
          const jitter = randf(-0.6, 0.6);
          const vx = dirX * randf(2, 5) + jitter;
          const vy = dirY * randf(2, 5) + jitter;
          const life = randf(0.3, 0.8);
          const size = randf(1.5, 4);
          this.particles.push(new Particle(x, y, vx, vy, color, life, size, false));
        }
      }
      /** Updates all particles. */
      update(dt) {
        for (let i = this.particles.length - 1; i >= 0; i--) {
          if (!this.particles[i].update(dt)) this.particles.splice(i, 1);
        }
      }
      /** Draws all particles. */
      draw(ctx) {
        for (let i = 0; i < this.particles.length; i++) {
          this.particles[i].draw(ctx);
        }
        if (this.debugDraw) {
          ctx.save();
          ctx.fillStyle = "rgba(255,255,255,0.6)";
          ctx.font = "12px monospace";
          ctx.fillText(`Particles: ${this.particles.length}/${this.max}`, 12, 24);
          ctx.restore();
        }
      }
      /** Adjusts max based on performance mode. */
      setPerformanceMode(on) {
        this.max = on ? MAX_PARTICLES_PERF : MAX_PARTICLES;
      }
      /** Toggles debug draw. */
      setDebug(on) { this.debugDraw = on; }
    }

    /** Global particle system instance. */
    const particles = new ParticleSystem();

    /* -------------------------------------------------------------------------
       Production Systems
       ------------------------------------------------------------------------- */
    /** Building definitions with base cost and production. */
    const BUILDINGS = [
      { id: "cursor", name: "Cursor", desc: "Auto-clicks occasionally.", baseCost: 15, baseBps: 0.1 },
      { id: "oven", name: "Oven", desc: "Bakes biscuits steadily.", baseCost: 100, baseBps: 1.0 },
      { id: "bakery", name: "Bakery", desc: "A full bakery line.", baseCost: 1100, baseBps: 8.0 },
      { id: "factory", name: "Factory", desc: "Industrial biscuit factory.", baseCost: 12000, baseBps: 47.0 },
      { id: "quantum", name: "Quantum Yeast Lab", desc: "Entangles flavors for exponential gains.", baseCost: 130000, baseBps: 260.0 },
      { id: "portal", name: "Sugar Portal", desc: "Imports sweetness from beyond.", baseCost: 1400000, baseBps: 1400.0 },
      { id: "planet", name: "Biscuit Planet", desc: "A whole world dedicated to biscuits.", baseCost: 20000000, baseBps: 7800.0 },
    ];
    /** Factory upgrades that multiply building outputs. */
    const FACTORY_UPGRADES = [
      { id: "steelTrays", name: "Steel Trays", desc: "Ovens +25% output.", target: "oven", mult: 1.25, baseCost: 500 },
      { id: "conveyorBoost", name: "Conveyor Boost", desc: "Factory +25% output.", target: "factory", mult: 1.25, baseCost: 5000 },
      { id: "quantumStir", name: "Quantum Stir", desc: "Quantum +25% output.", target: "quantum", mult: 1.25, baseCost: 50000 },
    ];
    /** Research tech with permanent effects. */
    const RESEARCH = [
      { id: "betterClick", name: "Better Click", desc: "+1 biscuit per click.", baseCost: 1000 },
      { id: "goldenLuck", name: "Golden Luck", desc: "Golden biscuits spawn more often.", baseCost: 5000 },
      { id: "prestigeBoost", name: "Prestige Boost", desc: "+10% prestige multiplier.", baseCost: 20000 },
    ];
    /** Achievements definitions. */
    const ACHIEVEMENTS = [
      { id: "firstClick", name: "First Click", desc: "Click the big biscuit once." },
      { id: "hundredClicks", name: "Click Storm", desc: "Reach 100 clicks." },
      { id: "firstGolden", name: "Golden Touch", desc: "Click a golden biscuit." },
      { id: "firstPrestige", name: "Ascendant", desc: "Perform your first prestige." },
    ];

    /** Computes cost scaling for building count. */
    function buildingCost(base, count) {
      return Math.floor(base * Math.pow(1.15, count));
    }
    /** Computes total B/s from buildings and upgrades. */
    function computeBps() {
      let bps = 0;
      const mults = {};
      // Apply factory upgrades
      for (const up of FACTORY_UPGRADES) {
        const level = save.factoryUpgrades[up.id] || 0;
        if (level > 0) {
          mults[up.target] = (mults[up.target] || 1) * Math.pow(up.mult, level);
        }
      }
      // Buildings
      for (const b of BUILDINGS) {
        const count = save.buildings[b.id] || 0;
        const m = mults[b.id] || 1;
        bps += count * b.baseBps * m;
      }
      // Research: prestigeBoost adds 10% per unlock
      if (save.research["prestigeBoost"]) {
        bps *= 1.1;
      }
      // Prestige crumbs multiplier: 1 + crumbs * 0.01
      bps *= (1 + save.prestigeCrumbs * 0.01);
      return bps;
    }

    /* -------------------------------------------------------------------------
       Golden Biscuit Spawner
       ------------------------------------------------------------------------- */
    /** Next golden spawn timestamp. */
    let nextGoldenAt = Date.now() + randi(GOLDEN_MIN_MS, GOLDEN_MAX_MS);
    /** Active golden biscuit element (if any). */
    let goldenEl = null;

    /** Schedules next golden spawn based on seed and research. */
    function scheduleGolden() {
      const prng = makePRNG(save.seed + save.goldenCount);
      const baseMin = GOLDEN_MIN_MS * (save.research["goldenLuck"] ? 0.8 : 1.0);
      const baseMax = GOLDEN_MAX_MS * (save.research["goldenLuck"] ? 0.8 : 1.0);
      const ms = Math.floor(lerp(baseMin, baseMax, prng()));
      nextGoldenAt = Date.now() + ms;
    }
    /** Spawns a golden biscuit at a random position. */
    function spawnGolden() {
      if (goldenEl) return;
      goldenEl = document.createElement("div");
      goldenEl.className = "golden";
      const x = randi(80, window.innerWidth - 80);
      const y = randi(120, window.innerHeight - 120);
      goldenEl.style.left = x + "px";
      goldenEl.style.top = y + "px";
      goldenEl.style.position = "fixed";
      document.body.appendChild(goldenEl);
      const onClick = (ev) => {
        ev.stopPropagation();
        // Reward: burst biscuits and particles
        const reward = 1000 + Math.floor(computeBps() * 20);
        save.biscuits += reward;
        save.totalBiscuits += reward;
        save.goldenCount += 1;
        hudGoldenEl.textContent = save.goldenCount;
        playPurchase();
        particles.burst(x, y, 80, "rgba(255,209,102,0.9)");
        // Achievement
        unlockAchievement("firstGolden");
        // Cleanup
        goldenEl.removeEventListener("click", onClick);
        document.body.removeChild(goldenEl);
        goldenEl = null;
        scheduleGolden();
      };
      goldenEl.addEventListener("click", onClick);
      // Auto-despawn after 8s
      setTimeout(() => {
        if (goldenEl) {
          document.body.removeChild(goldenEl);
          goldenEl = null;
          scheduleGolden();
        }
      }, 8000);
    }

    /* -------------------------------------------------------------------------
       UI Builders
       ------------------------------------------------------------------------- */
    /** Renders building list with buy buttons. */
    function renderBuildings() {
      buildingList.innerHTML = "";
      for (const b of BUILDINGS) {
        const count = save.buildings[b.id] || 0;
        const cost = buildingCost(b.baseCost, count);
        const el = document.createElement("div");
        el.className = "building";
        el.innerHTML = `
          <div>
            <div class="building-title">${b.name} <span class="label">x${count}</span></div>
            <div class="building-desc">${b.desc} — <span class="label">Cost: ${formatNum(cost)}</span></div>
          </div>
          <div class="building-controls">
            <button class="btn btn-primary">Buy</button>
          </div>
        `;
        const btn = el.querySelector("button");
        btn.addEventListener("click", () => {
          if (save.biscuits >= cost) {
            save.biscuits -= cost;
            save.buildings[b.id] = count + 1;
            playPurchase();
            particles.burst(window.innerWidth - 220, 140, 40, "rgba(108,240,255,0.9)");
            renderBuildings();
            updateHud();
            writeSave();
          } else {
            playError();
            showToast("Not enough biscuits!", true);
          }
        });
        buildingList.appendChild(el);
      }
    }
    /** Renders factory upgrades with level buttons. */
    function renderFactory() {
      factoryList.innerHTML = "";
      for (const up of FACTORY_UPGRADES) {
        const level = save.factoryUpgrades[up.id] || 0;
        const cost = Math.floor(up.baseCost * Math.pow(2, level));
        const el = document.createElement("div");
        el.className = "building";
        el.innerHTML = `
          <div>
            <div class="building-title">${up.name} <span class="label">Lv.${level}</span></div>
            <div class="building-desc">${up.desc} — <span class="label">Cost: ${formatNum(cost)}</span></div>
          </div>
          <div class="building-controls">
            <button class="btn btn-primary">Upgrade</button>
          </div>
        `;
        const btn = el.querySelector("button");
        btn.addEventListener("click", () => {
          if (save.biscuits >= cost) {
            save.biscuits -= cost;
            save.factoryUpgrades[up.id] = level + 1;
            playPurchase();
            particles.stream(window.innerWidth - 220, 140, -1, 0, 60, "rgba(108,240,255,0.7)");
            renderFactory();
            updateHud();
            writeSave();
          } else {
            playError();
            showToast("Not enough biscuits!", true);
          }
        });
        factoryList.appendChild(el);
      }
    }
    /** Renders research tech with unlock buttons. */
    function renderResearch() {
      researchGrid.innerHTML = "";
      for (const r of RESEARCH) {
        const unlocked = !!save.research[r.id];
        const el = document.createElement("div");
        el.className = "research-card";
        el.innerHTML = `
          <div class="research-title">${r.name} ${unlocked ? '<span class="badge">Unlocked</span>' : ''}</div>
          <div class="research-desc">${r.desc}</div>
          <div class="research-cost">Cost: ${formatNum(r.baseCost)}</div>
          <button class="btn ${unlocked ? '' : 'btn-primary'}">${unlocked ? 'Owned' : 'Unlock'}</button>
        `;
        const btn = el.querySelector("button");
        btn.disabled = unlocked;
        btn.addEventListener("click", () => {
          if (unlocked) return;
          if (save.biscuits >= r.baseCost) {
            save.biscuits -= r.baseCost;
            save.research[r.id] = true;
            playPurchase();
            particles.burst(window.innerWidth / 2, window.innerHeight / 2, 100, "rgba(77,255,136,0.9)");
            renderResearch();
            updateHud();
            writeSave();
          } else {
            playError();
            showToast("Not enough biscuits!", true);
          }
        });
        researchGrid.appendChild(el);
      }
    }
    /** Renders achievements grid. */
    function renderAchievements() {
      achievementsGrid.innerHTML = "";
      for (const a of ACHIEVEMENTS) {
        const unlocked = !!save.achievements[a.id];
        const el = document.createElement("div");
        el.className = "achievement" + (unlocked ? " unlocked" : "");
        el.innerHTML = `
          <div class="achievement-title">${a.name}</div>
          <div class="achievement-desc">${a.desc}</div>
        `;
        achievementsGrid.appendChild(el);
      }
    }

    /** Unlocks an achievement by id. */
    function unlockAchievement(id) {
      if (!save.achievements[id]) {
        save.achievements[id] = true;
        showToast("Achievement unlocked!");
        writeSave();
        renderAchievements();
      }
    }

    /* -------------------------------------------------------------------------
       HUD & Stats
       ------------------------------------------------------------------------- */
    /** Updates HUD values. */
    function updateHud() {
      hudBiscuitsEl.textContent = formatNum(save.biscuits);
      hudBpsEl.textContent = formatNum(computeBps());
      hudPrestigeEl.textContent = formatNum(save.prestigeCrumbs);
      hudGoldenEl.textContent = save.goldenCount;
      hudSeedEl.textContent = save.seed;
      hudAdminEl.textContent = save.adminUnlocked ? "Unlocked" : "Locked";
      statTotalEl.textContent = formatNum(save.totalBiscuits);
      statClicksEl.textContent = save.clicks;
    }
    /** Updates session time stat. */
    function updateSessionTime() {
      const secs = Math.floor((Date.now() - save.lastSessionStart) / 1000);
      statTimeEl.textContent = `${secs}s`;
    }

    /* -------------------------------------------------------------------------
       Click Handling
       ------------------------------------------------------------------------- */
    /** Handles big biscuit click: adds biscuits, plays effects, tracks stats. */
    function onBigBiscuitClick(ev) {
      const rect = bigBiscuit.getBoundingClientRect();
      const x = ev.clientX;
      const y = ev.clientY;
      const baseClick = 1 + (save.research["betterClick"] ? 1 : 0);
      const gain = baseClick * (1 + save.prestigeCrumbs * 0.01);
      save.biscuits += gain;
      save.totalBiscuits += gain;
      save.clicks += 1;
      unlockAchievement("firstClick");
      if (save.clicks >= 100) unlockAchievement("hundredClicks");
      playClick();
      bigBiscuit.classList.add("biscuit-click");
      setTimeout(() => bigBiscuit.classList.remove("biscuit-click"), 120);
      particles.burst(x, y, 24, "rgba(255,243,214,0.9)");
      updateHud();
      writeSave();
    }

    /* -------------------------------------------------------------------------
       Prestige
       ------------------------------------------------------------------------- */
    /** Computes prestige crumbs from total biscuits. */
    function computePrestigeCrumbs(total) {
      return Math.floor(Math.pow(total / 1e6, 0.5));
    }
    /** Performs prestige: resets biscuits/buildings, grants crumbs. */
    function doPrestige() {
      const crumbs = computePrestigeCrumbs(save.totalBiscuits);
      if (crumbs <= 0) {
        playError();
        showToast("Not enough total biscuits to ascend!", true);
        return;
      }
      save.prestige += 1;
      save.prestigeCrumbs += crumbs;
      // Reset production
      save.biscuits = 0;
      save.buildings = {};
      save.factoryUpgrades = {};
      // Keep research and achievements
      playPrestige();
      particles.burst(window.innerWidth / 2, window.innerHeight / 2, 200, "rgba(77,255,136,0.9)");
      showToast(`Ascended! +${crumbs} crumbs`);
      updateHud();
      writeSave();
    }

    /* -------------------------------------------------------------------------
       Admin Mode
       ------------------------------------------------------------------------- */
    /** Attempts to unlock admin mode with the provided password. */
    function unlockAdmin(password) {
      if (password === ADMIN_PASSWORD) {
        save.adminUnlocked = true;
        adminLogLine("Admin unlocked.");
        playAdminUnlock();
        showToast("Admin unlocked!");
        hudAdminEl.textContent = "Unlocked";
        writeSave();
      } else {
        adminLogLine("Invalid password attempt.");
        playError();
        showToast("Invalid password!", true);
      }
    }
    /** Ensures admin is unlocked before performing action. */
    function requireAdmin(actionName) {
      if (!save.adminUnlocked) {
        adminLogLine(`Denied: ${actionName} (admin locked)`);
        playError();
        showToast("Admin locked!", true);
        return false;
      }
      return true;
    }
    /** Admin: give biscuits. */
    function adminGiveBiscuits(amount) {
      if (!requireAdmin("Give Biscuits")) return;
      save.biscuits += amount;
      save.totalBiscuits += amount;
      adminLogLine(`Gave ${formatNum(amount)} biscuits.`);
      particles.burst(window.innerWidth / 2, 120, 120, "rgba(108,240,255,0.9)");
      playPurchase();
      updateHud();
      writeSave();
    }
    /** Admin: max upgrades. */
    function adminMaxUpgrades() {
      if (!requireAdmin("Max Upgrades")) return;
      for (const up of FACTORY_UPGRADES) {
        save.factoryUpgrades[up.id] = 10;
      }
      for (const r of RESEARCH) {
        save.research[r.id] = true;
      }
      adminLogLine("Maxed factory upgrades and unlocked all research.");
      particles.burst(window.innerWidth / 2, window.innerHeight / 2, 200, "rgba(77,255,136,0.9)");
      playPurchase();
      updateHud();
      writeSave();
    }
    /** Admin: spawn golden biscuit. */
    function adminSpawnGolden() {
      if (!requireAdmin("Spawn Golden")) return;
      spawnGolden();
      adminLogLine("Spawned golden biscuit.");
    }
    /** Admin: wipe save. */
    function adminWipe() {
      if (!requireAdmin("Wipe Save")) return;
      wipeSave();
      adminLogLine("Save wiped.");
      updateHud();
      renderBuildings();
      renderFactory();
      renderResearch();
      renderAchievements();
      showToast("Save wiped!");
    }

    /* -------------------------------------------------------------------------
       Debug & Settings
       ------------------------------------------------------------------------- */
    /** Applies settings to systems. */
    function applySettings() {
      setVolume(save.settings.volume);
      particles.setPerformanceMode(save.settings.performance);
      particles.setDebug(save.settings.debugParticles);
    }

    /* -------------------------------------------------------------------------
       Game Loop
       ------------------------------------------------------------------------- */
    /** Last timestamp for tick pacing. */
    let lastTime = performance.now();

    /** Main loop: updates production, particles, and draws FX. */
    function loop(now) {
      const dtMs = now - lastTime;
      lastTime = now;
      const dt = dtMs / 1000;

      // Production: biscuits per second
      const bps = computeBps();
      save.biscuits += bps * dt;
      save.totalBiscuits += bps * dt;

      // Golden spawn check
      if (Date.now() >= nextGoldenAt) {
        spawnGolden();
      }

      // Update HUD periodically
      updateHud();
      updateSessionTime();

      // Particles
      particles.update(dt);

      // Draw FX
      fxCtx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);
      particles.draw(fxCtx);

      requestAnimationFrame(loop);
    }

    /* -------------------------------------------------------------------------
       Event Wiring
       ------------------------------------------------------------------------- */
    function wireEvents() {
      // Menu
      btnStart.addEventListener("click", () => { setState(State.BAKERY); renderBuildings(); });
      btnFactory.addEventListener("click", () => { setState(State.FACTORY); renderFactory(); });
      btnResearch.addEventListener("click", () => { setState(State.RESEARCH); renderResearch(); });
      btnPrestige.addEventListener("click", () => { setState(State.PRESTIGE); });
      btnAchievements.addEventListener("click", () => { setState(State.ACHIEVEMENTS); renderAchievements(); });
      btnSettings.addEventListener("click", () => { setState(State.SETTINGS); });
      btnAdmin.addEventListener("click", () => { setState(State.ADMIN); });

      // Bakery
      bigBiscuit.addEventListener("click", onBigBiscuitClick);
      btnBackFromBakery.addEventListener("click", () => setState(State.MENU));

      // Factory
      btnBackFromFactory.addEventListener("click", () => setState(State.MENU));

      // Research
      btnBackFromResearch.addEventListener("click", () => setState(State.MENU));

      // Prestige
      btnAscend.addEventListener("click", () => doPrestige());
      btnBackFromPrestige.addEventListener("click", () => setState(State.MENU));

      // Achievements
      btnBackFromAchievements.addEventListener("click", () => setState(State.MENU));

      // Settings
      volumeSlider.value = save.settings.volume;
      volumeSlider.addEventListener("input", (e) => {
        save.settings.volume = parseFloat(e.target.value);
        setVolume(save.settings.volume);
        writeSave();
      });
      btnReducedMotion.addEventListener("click", () => {
        save.settings.reducedMotion = !save.settings.reducedMotion;
        showToast(`Reduced Motion: ${save.settings.reducedMotion ? "On" : "Off"}`);
        writeSave();
      });
      btnColorblind.addEventListener("click", () => {
        save.settings.colorblind = !save.settings.colorblind;
        showToast(`Colorblind Mode: ${save.settings.colorblind ? "On" : "Off"}`);
        writeSave();
      });
      btnPerf.addEventListener("click", () => {
        save.settings.performance = !save.settings.performance;
        particles.setPerformanceMode(save.settings.performance);
        showToast(`Performance Mode: ${save.settings.performance ? "On" : "Off"}`);
        writeSave();
      });
      btnApplySeed.addEventListener("click", () => {
        const s = (seedInput.value || "").trim();
        if (!s) { playError(); showToast("Seed cannot be empty!", true); return; }
        save.seed = s;
        hudSeedEl.textContent = save.seed;
        scheduleGolden();
        showToast("Seed applied!");
        writeSave();
      });
      btnDebugParticles.addEventListener("click", () => {
        save.settings.debugParticles = !save.settings.debugParticles;
        particles.setDebug(save.settings.debugParticles);
        showToast(`Debug Particles: ${save.settings.debugParticles ? "On" : "Off"}`);
        writeSave();
      });
      btnDebugAudio.addEventListener("click", () => {
        save.settings.debugAudio = !save.settings.debugAudio;
        showToast(`Debug Audio: ${save.settings.debugAudio ? "On" : "Off"}`);
        writeSave();
      });
      btnDebugPerf.addEventListener("click", () => {
        save.settings.debugPerf = !save.settings.debugPerf;
        showToast(`Debug Perf: ${save.settings.debugPerf ? "On" : "Off"}`);
        writeSave();
      });
      btnBackFromSettings.addEventListener("click", () => setState(State.MENU));

      // Admin
      btnUnlockAdmin.addEventListener("click", () => unlockAdmin(adminPasswordInput.value));
      btnAdminGive1e6.addEventListener("click", () => adminGiveBiscuits(1e6));
      btnAdminMaxUpgrades.addEventListener("click", () => adminMaxUpgrades());
      btnAdminSpawnGolden.addEventListener("click", () => adminSpawnGolden());
      btnAdminWipe.addEventListener("click", () => adminWipe());
      btnBackFromAdmin.addEventListener("click", () => setState(State.MENU));

      // Game Over
      btnRetry.addEventListener("click", () => { setState(State.BAKERY); });
      btnReturnMenu.addEventListener("click", () => { setState(State.MENU); });

      // Pause
      btnResume.addEventListener("click", () => setState(State.BAKERY));
      btnPauseMenu.addEventListener("click", () => setState(State.MENU));

      // Keyboard shortcuts
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (currentState !== State.PAUSED) {
            pauseStats.textContent = `Biscuits: ${formatNum(save.biscuits)} | B/s: ${formatNum(computeBps())}`;
            setState(State.PAUSED);
          } else {
            setState(State.BAKERY);
          }
        }
      });
    }

    /* -------------------------------------------------------------------------
       Initialization
       ------------------------------------------------------------------------- */
    function init() {
      resizeCanvas();
      loadSave();
      initAudio();
      applySettings();
      updateHud();
      renderAchievements();
      scheduleGolden();
      wireEvents();
      // Simulate loading
      setTimeout(() => setState(State.MENU), 800);
      requestAnimationFrame(loop);
    }

    // Start
    init();
  </script>
</body>
</html>
